During an internal Pentest Engagement, How I identified a Full Domain Compromise with an SMB relay Attack.

------------------
 ## Scenario ## 
------------------

1. Identify all Workstations without SMB Signing Enforced with Nmap

```
Command: nmap --script=smb2-security-mode.nse -p445 -iL hosts.txt
```

2. We will employ Responder and ntlmrelayx for this attack. First, it is essential to configure Responder correctly by disabling SMB and HTTP responses, as these will be relayed to ntlmrelayx.

```
sudo vim /etc/responder/Responder.conf
```

3. Start Responder with the below command

```
sudo responder –I eth0 -dw
```

4. In Another Terminal, Run the ntlmrelax and wait for the event to occur

```
sudo ntlmrelayx.py –tf all_live_hosts.txt –smb2support
```

5. An event, such as LLMNR poisoning, has occurred in the background. The Responder tool captures this event and forwards it to ntlmrelayx, which then relays the credentials to the targets specified in our targets file.

6. After a waiting period of thirty minutes, I obtained 16 NTLM hashes for the Local Administrator accounts.

7. Although RDP is enabled on every machine, the network administrator has configured the registry to prevent the Local Administrator account from logging in via Remote Desktop Protocol.

8. To enable Remote Desktop Protocol (RDP) access for all users, execute the following command:

```
reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v "UserAuthentication" /t REG_DWORD /d 1 /f
```

9. After gaining access to all 16 local Administrator accounts, I attempted to dump in-memory credentials using Mimikatz. However, the process was obstructed by Sophos EDR, resulting in all memory dumping tools failing to extract the credentials.

10. Disabling Sophos is not feasible without an administrator password, as it requires access to the main Sophos console. We have attempted various methods to extract the hashes, but all attempts were unsuccessful due to Sophos's detection of these methods.

12. After extensive research, I discovered that using hashtag#NetExec --lsa dump is an effective method for dumping hashes, which remain undetectable by hashtag#SophosEDR

13. Extracted all LSA secrets from 16 local administrator accounts and identified the Administrator passwords for the DC01, DC02, and DC03 machines.

14. I successfully logged onto the DC01, DC02, and DC03 machines using WINRM, granting us Domain Admin group privileges.

Next, I will demonstrate how to dump LSA Secrets while avoiding detection by all antivirus and endpoint detection and response (EDR) systems.
